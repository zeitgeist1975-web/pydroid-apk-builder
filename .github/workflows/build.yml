 name: Build APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk python3-pip unzip wget zip

      - name: Install Buildozer & Cython
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --user buildozer cython
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV

      - name: Install Android commandline tools + SDK + build-tools
        env:
          ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
        run: |
          set -e
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd /tmp

          # get concrete commandlinetools zip URL from developer.android.com
          TOOL_URL=$(curl -s https://developer.android.com/studio | grep -oE 'https://dl.google.com/android/repository/commandlinetools-linux-[0-9_]+_latest.zip' | head -n1)

          if [ -z "$TOOL_URL" ]; then
            echo "ERROR: couldn't find commandlinetools download URL on developer.android.com"
            exit 1
          fi

          echo "Downloading command line tools from: $TOOL_URL"
          wget -q "$TOOL_URL" -O cmdline-tools.zip

          if ! unzip -tq cmdline-tools.zip >/dev/null 2>&1; then
            echo "Downloaded file is not a valid zip. Dump head for debugging:"
            head -n 200 cmdline-tools.zip || true
            exit 1
          fi

          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"

          # normalize folder so sdkmanager lives in cmdline-tools/latest/bin
          if [ -d "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" ]; then
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
          elif [ -d "$ANDROID_SDK_ROOT/cmdline-tools/tools" ]; then
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv "$ANDROID_SDK_ROOT/cmdline-tools/tools"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
          fi

          echo "PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

          # accept licenses and install platform/build-tools
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
          "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "platform-tools" "platforms;android-31" "build-tools;36.1.0" --install-if-needed

      - name: Show installed SDK tools
        env:
          ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
        run: |
          echo "SDK root: $ANDROID_SDK_ROOT"
          ls -la "$ANDROID_SDK_ROOT/build-tools" || true
          which aidl || true
          "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --list || true

      - name: Build APK (debug)
        env:
          ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
          JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
        run: |
          echo "PATH=$HOME/.local/bin:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH" >> $GITHUB_ENV
          aidl --version || echo "aidl not found yet"
          buildozer -v android debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: bin/*.apk
